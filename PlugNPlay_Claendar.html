
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeTrialGuard - Your Mindful Trial Companion</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRnJlZVRyaWFsR3VhcmQiLCJzaG9ydF9uYW1lIjoiVHJpYWxHdWFyZCIsImRlc2NyaXB0aW9uIjoiWW91ciBtaW5kZnVsIHRyaWFsIGNvbXBhbmlvbiIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM3NDE1MSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmYWZjIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBLVR6Z2lJR1pwYkd3OUlpTXpOemN4TlRFaVBqeHdZWFJvSUdROUltMDJOQ0EySUV3eE1qSWdOaUJzTUNBeE1UWWdNVElnTUNCc01USXVMV0V4TWkxTWJETTJMaUF5TkNBeU5DQXlOQ0IxSUVGNk1UUWdNamd1T0RBME1qa3VNRGc0TVRZZ01qZ3VNRGd5TkRJZ05UUXVNRFF3TlRJZ05UUXVNREF5TlRjZ09UQXVPVFF6T0RBZ09UQXVPVE0xTnpjZ01USTBMRFV6TVRZMklERXlOQzQxTXpFMk5qWlNNVEl1TFRkZ2VHaERaekE0THpocVkyRTVNRE14SWpwOEwzTjJaejQ9IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjEyOHgxMjgifV19">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        .gentle-shadow {
            box-shadow: 0 4px 20px rgba(56, 178, 172, 0.08);
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-gentle {
            animation: pulseGentle 2s infinite;
        }
        @keyframes pulseGentle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .notification-success {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
        }
        .notification-warning {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
        }
        .notification-gentle {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
            color: #0C4A6E;
        }
        .radio-option {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .radio-option:hover {
            border-color: #93C5FD;
            background-color: #F8FAFC;
        }
        .radio-option input:checked + .radio-content {
            border-color: #3B82F6;
            background: linear-gradient(135deg, #EBF4FF 0%, #DBEAFE 100%);
        }
        .push-notification-info {
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            border: 2px solid #7DD3FC;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }
        /* RESPONSIVE FIX: Modal positioning improvements */
        .modal-container {
            max-height: 100vh;
            overflow-y: auto;
            padding: 1rem;
        }
        @media (max-height: 600px) {
            .modal-container {
                padding: 0.5rem;
                align-items: flex-start;
                justify-content: center;
            }
        }
        .modal-content {
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        @media (max-height: 600px) {
            .modal-content {
                max-height: calc(100vh - 1rem);
            }
        }
        /* Upgrade section styling */
        .upgrade-section {
            background: linear-gradient(135deg, #FEF3E2 0%, #FDE68A 100%);
            border: 2px solid #F59E0B;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        .upgrade-form {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid #E5E7EB;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-indigo-50 min-h-screen">
    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="hidden fixed top-4 left-4 right-4 z-50 bg-white rounded-xl p-4 gentle-shadow">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fas fa-mobile-alt text-blue-500"></i>
                <span class="text-gray-700">Add FreeTrialGuard to your home screen for peaceful access</span>
            </div>
            <div class="flex space-x-2">
                <button id="installApp" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">
                    Add
                </button>
                <button id="dismissInstall" class="px-4 py-2 text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="hidden fixed top-20 left-4 right-4 z-40 rounded-xl p-4 text-center transition-all duration-300">
        <div id="toastContent" class="font-medium"></div>
    </div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm border-b border-blue-100 sticky top-0 z-30">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-800">FreeTrialGuard</h1>
                        <p class="text-sm text-gray-500">Your mindful trial companion</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="privacyInfo" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Privacy Information">
                        <i class="fas fa-user-shield text-gray-600"></i>
                    </button>
                    <button id="addTrialBtn" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-200 gentle-shadow">
                        <i class="fas fa-plus mr-2"></i>Add Trial
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Welcome Message -->
        <div id="welcomeMessage" class="text-center mb-8 fade-in">
            <h2 class="text-2xl font-light text-gray-700 mb-2">We'll remind you gently,</h2>
            <p class="text-lg text-gray-500">just before it matters.</p>
            <div class="mt-4 text-sm text-gray-400">
                <i class="fas fa-heart text-red-300 mr-1"></i>
                Your data never leaves your device
            </div>
        </div>

        <!-- Trials Dashboard -->
        <div id="trialsContainer" class="space-y-4">
            <!-- Trials will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 fade-in">
            <div class="w-24 h-24 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-leaf text-3xl text-blue-400"></i>
            </div>
            <h3 class="text-xl font-light text-gray-600 mb-2">Your peaceful space awaits</h3>
            <p class="text-gray-500 mb-6">Add your first trial and let us handle the gentle reminders</p>
            <button class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-200 gentle-shadow">
                <i class="fas fa-plus mr-2"></i>Add Your First Trial
            </button>
        </div>

        <!-- Test Reminder Section -->
        <div class="mt-12 text-center">
            <button id="testReminder" class="text-blue-500 hover:text-blue-600 transition-colors text-sm">
                <i class="fas fa-flask mr-1"></i>Test reminder system
            </button>
        </div>
    </main>

    <!-- IMPROVED Add Trial Modal with Calendar Feature and Responsive Layout -->
    <div id="addTrialModal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 modal-container flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-md gentle-shadow fade-in modal-content">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Add New Trial</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="trialForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Name</label>
                        <input type="text" id="serviceName" placeholder="Netflix, Spotify, etc." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trial End Date</label>
                        <input type="date" id="endDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">How would you like to be reminded?</label>

                        <!-- Radio Button Implementation -->
                        <div class="space-y-3">
                            <!-- Browser Notifications (Default) -->
                            <label class="radio-option block cursor-pointer">
                                <input type="radio" name="reminderMethod" value="push" checked class="sr-only">
                                <div class="radio-content">
                                    <div class="flex items-start space-x-3">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-4 h-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                                <div class="w-2 h-2 bg-blue-500 rounded-full hidden"></div>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-bell text-blue-500"></i>
                                                <span class="font-medium text-gray-800">Browser Notifications</span>
                                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Recommended</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1">Gentle notifications appear directly in your browser - no setup needed!</p>
                                        </div>
                                    </div>
                                </div>
                            </label>

                            <!-- Push Notification Info Box -->
                            <div id="pushNotificationInfo" class="push-notification-info">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                                    <div class="text-sm">
                                        <p class="font-medium text-blue-800 mb-1">Peaceful Browser Reminders</p>
                                        <p class="text-blue-700">You'll receive gentle notifications directly in your browser window. No email or phone number needed - just mindful reminders when you're online.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Email Option -->
                            <label class="radio-option block cursor-pointer">
                                <input type="radio" name="reminderMethod" value="email" class="sr-only">
                                <div class="radio-content">
                                    <div class="flex items-start space-x-3">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-4 h-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                                <div class="w-2 h-2 bg-blue-500 rounded-full hidden"></div>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-envelope text-indigo-500"></i>
                                                <span class="font-medium text-gray-800">Email Reminders</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1">Receive gentle email notifications via our secure service</p>
                                        </div>
                                    </div>
                                </div>
                            </label>

                            <!-- SMS Option -->
                            <label class="radio-option block cursor-pointer">
                                <input type="radio" name="reminderMethod" value="sms" class="sr-only">
                                <div class="radio-content">
                                    <div class="flex items-start space-x-3">
                                        <div class="flex-shrink-0 mt-1">
                                            <div class="w-4 h-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                                <div class="w-2 h-2 bg-blue-500 rounded-full hidden"></div>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-sms text-green-500"></i>
                                                <span class="font-medium text-gray-800">SMS Reminders</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1">Get text message notifications on your phone</p>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Dynamic Contact Fields -->
                    <div id="emailField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="emailAddress" placeholder="your@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                    </div>

                    <div id="smsField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="phoneNumber" placeholder="+1234567890" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                    </div>

                    <!-- REPLACED: Calendar Button instead of Notes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Calendar Reminder</label>
                        <button type="button" id="addToCalendar" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 flex items-center justify-center space-x-2">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Add to Calendar</span>
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Download a calendar file with automatic reminders (7, 3, and 1 day before)</p>
                    </div>

                    <!-- NEW: Upgrade Section -->
                    <div class="upgrade-section">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-star text-yellow-500"></i>
                            <h4 class="font-medium text-gray-800">Upgrade to receive Email and SMS reminders for only $2.99!</h4>
                        </div>

                        <div class="upgrade-form">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <input type="email" id="upgradeEmail" placeholder="your@email.com" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent outline-none">
                                <input type="tel" id="upgradePhone" placeholder="+1234567890" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent outline-none">
                            </div>
                            
                        </div>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelBtn" class="flex-1 px-4 py-3 text-gray-600 hover:text-gray-800 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-3 rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-200">
                            Add Trial
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div id="privacyModal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg gentle-shadow fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Your Privacy Matters</h3>
                <button id="closePrivacyModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-4 text-gray-600">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-shield-alt text-green-500 mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-800">Local Storage Only</h4>
                        <p class="text-sm">All your trial data stays on your device. We never sync to the cloud.</p>
                    </div>
                </div>

                <div class="flex items-start space-x-3">
                    <i class="fas fa-user-slash text-blue-500 mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-800">No Tracking</h4>
                        <p class="text-sm">We don't use analytics, cookies, or any tracking technologies.</p>
                    </div>
                </div>

                <div class="flex items-start space-x-3">
                    <i class="fas fa-bell text-indigo-500 mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-800">Secure Reminder Services</h4>
                        <p class="text-sm">Email and SMS reminders are sent through our secure backend service - no API keys or technical details exposed to you.</p>
                    </div>
                </div>

                <div class="flex items-start space-x-3">
                    <i class="fas fa-heart text-red-400 mt-1"></i>
                    <div>
                        <h4 class="font-medium text-gray-800">Built with Care</h4>
                        <p class="text-sm">This app respects your emotional bandwidth and digital well-being.</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-100">
                <button id="closePrivacyBtn" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-3 rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-200">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <script>
        // NOVU INTEGRATION CONFIGURATION
        const NovuConfig = {
            API_KEY: 'NOVU_API_KEY_HERE',
            ENDPOINT: 'https://api.novu.co/v1/notifications'
        };

        // ICS CALENDAR FILE GENERATION
        function generateICSFile(serviceName, endDate) {
            const eventDate = new Date(endDate);
            const now = new Date();

            // Format dates for ICS (YYYYMMDDTHHMMSSZ)
            function formatICSDate(date) {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }

            // Create alarm dates (7, 3, 1 days before)
            const alarmDates = [7, 3, 1].map(days => {
                const alarmDate = new Date(eventDate);
                alarmDate.setDate(alarmDate.getDate() - days);
                return {
                    days: days,
                    date: formatICSDate(alarmDate)
                };
            });

            const eventStart = formatICSDate(eventDate);
            const eventEnd = formatICSDate(new Date(eventDate.getTime() + 60 * 60 * 1000)); // 1 hour duration
            const created = formatICSDate(now);

            // Generate unique UID
            const uid = `freetrial-${Date.now()}@freetrialguard.app`;

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FreeTrialGuard//Trial Reminder//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
DTSTART:${eventStart}
DTEND:${eventEnd}
DTSTAMP:${created}
UID:${uid}
CREATED:${created}
DESCRIPTION:Your free trial ends today. Take action if needed.
LAST-MODIFIED:${created}
LOCATION:
SEQUENCE:0
STATUS:CONFIRMED
SUMMARY:Trial Ends â FreeTrialGuard
TRANSP:OPAQUE
${alarmDates.map(alarm => `BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Your ${serviceName} trial ends in ${alarm.days} day${alarm.days !== 1 ? 's' : ''}
TRIGGER;VALUE=DATE-TIME:${alarm.date}
END:VALARM`).join('\n')}
${alarmDates.map(alarm => `BEGIN:VALARM
ACTION:AUDIO
DESCRIPTION:Trial reminder sound
TRIGGER;VALUE=DATE-TIME:${alarm.date}
ATTACH;VALUE=URI:Basso
END:VALARM`).join('\n')}
END:VEVENT
END:VCALENDAR`;

            return icsContent;
        }

        function downloadICSFile(serviceName, endDate) {
            const icsContent = generateICSFile(serviceName, endDate);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = `${serviceName.replace(/[^a-zA-Z0-9]/g, '_')}_trial_reminder.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast(`Calendar file downloaded for ${serviceName}!`, 'success');
        }

        // NOVU INTEGRATION FUNCTION
        async function sendToNovu(email, phone, serviceName, endDate) {
            try {
                const response = await fetch(NovuConfig.ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `ApiKey ${NovuConfig.API_KEY}`
                    },
                    body: JSON.stringify({
                        name: 'trial-reminder-signup',
                        to: {
                            subscriberId: email,
                            email: email,
                            phone: phone
                        },
                        payload: {
                            serviceName: serviceName,
                            endDate: endDate,
                            signupDate: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    showToast('Successfully subscribed to premium notifications!', 'success');
                    return true;
                } else {
                    throw new Error('Novu API error');
                }
            } catch (error) {
                console.error('Novu integration error:', error);
                showToast('Upgrade service temporarily unavailable. Your calendar reminder is still active!', 'warning');
                return false;
            }
        }

        // App State
        let trials = [];
        let notificationPermission = 'default';
        let deferredPrompt;

        // DOM Elements
        const elements = {
            trialsContainer: document.getElementById('trialsContainer'),
            emptyState: document.getElementById('emptyState'),
            addTrialBtn: document.getElementById('addTrialBtn'),
            addTrialModal: document.getElementById('addTrialModal'),
            trialForm: document.getElementById('trialForm'),
            closeModal: document.getElementById('closeModal'),
            cancelBtn: document.getElementById('cancelBtn'),
            privacyInfo: document.getElementById('privacyInfo'),
            privacyModal: document.getElementById('privacyModal'),
            closePrivacyModal: document.getElementById('closePrivacyModal'),
            closePrivacyBtn: document.getElementById('closePrivacyBtn'),
            testReminder: document.getElementById('testReminder'),
            toast: document.getElementById('toast'),
            toastContent: document.getElementById('toastContent'),
            installPrompt: document.getElementById('installPrompt'),
            installApp: document.getElementById('installApp'),
            dismissInstall: document.getElementById('dismissInstall'),
            pushNotificationInfo: document.getElementById('pushNotificationInfo'),
            addToCalendar: document.getElementById('addToCalendar'),
        };

        // IndexedDB Setup for local storage
        let db;
        const dbName = 'FreeTrialGuardDB';
        const dbVersion = 1;

        function initDB() {
            const request = indexedDB.open(dbName, dbVersion);

            request.onerror = () => {
                console.error('Database error:', request.error);
                showToast('Database initialization failed', 'warning');
            };

            request.onsuccess = () => {
                db = request.result;
                loadTrials();
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const objectStore = db.createObjectStore('trials', { keyPath: 'id' });
                objectStore.createIndex('endDate', 'endDate', { unique: false });
            };
        }

        // Data Management
        function saveTrials() {
            if (!db) return;

            const transaction = db.transaction(['trials'], 'readwrite');
            const objectStore = transaction.objectStore('trials');

            // Clear existing data
            objectStore.clear();

            // Add all current trials
            trials.forEach(trial => {
                objectStore.add(trial);
            });

            transaction.oncomplete = () => {
                console.log('Trials saved successfully');
            };

            transaction.onerror = () => {
                console.error('Error saving trials');
                showToast('Failed to save trials', 'warning');
            };
        }

        function loadTrials() {
            if (!db) return;

            const transaction = db.transaction(['trials'], 'readonly');
            const objectStore = transaction.objectStore('trials');
            const request = objectStore.getAll();

            request.onsuccess = () => {
                trials = request.result || [];
                renderTrials();
                scheduleAllReminders();
            };

            request.onerror = () => {
                console.error('Error loading trials');
                showToast('Failed to load trials', 'warning');
            };
        }

        // Notification Service
        class NotificationService {
            static async requestPermission() {
                if ('Notification' in window) {
                    notificationPermission = await Notification.requestPermission();
                    return notificationPermission === 'granted';
                }
                return false;
            }

            static showPushNotification(title, body) {
                if (notificationPermission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAtTzgiIGZpbGw9IiMzNzQxNTEiPjxwYXRoIGQ9Im02NCA2IEwxMjIgNiBsMCAxMTYgMTIgMCBsMTIuLWExMi1MMzYuIDI0IDI0IDI0IGIgQXoxNCAyOC44MDQyOS4wODgxNiAyOC4wODI0MiA1NC4wNDA1MiA1NC4wNDAyNTcgOTAuOTQzODAgOTAuOTM1NzcgMTI0LjUzMTY2IDEyNC41MzE2NlJMMTIuLTdnZGhDZzA4Lzh6Y2E5MDMxIi8+PC9zdmc+',
                        badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAtTzgiIGZpbGw9IiMzNzQxNTEiPjxwYXRoIGQ9Im02NCA2IEwxMjIgNiBsMCAxMTYgMTIgMCBsMTIuLWExMi1MMzYuIDI0IDI0IDI0IGIgQXoxNCAyOC44MDQyOS4wODgxNiAyOC4wODI0MiA1NC4wNDA1MiA1NC4wNDAyNTcgOTAuOTQzODAgOTAuOTM1NzcgMTI0LjUzMTY2IDEyNC41MzE2NlJMMTIuLTdnZGhDZzA4Lzh6Y2E5MDMxIi8+PC9zdmc+',
                        requireInteraction: false,
                        silent: true
                    });
                }
            }
        }

        // Radio Button Handling
        function setupReminderMethodHandlers() {
            const radioButtons = document.querySelectorAll('input[name="reminderMethod"]');
            const emailField = document.getElementById('emailField');
            const smsField = document.getElementById('smsField');
            const pushInfo = document.getElementById('pushNotificationInfo');

            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('emailAddress').value = '';
                    document.getElementById('phoneNumber').value = '';

                    emailField.classList.add('hidden');
                    smsField.classList.add('hidden');
                    pushInfo.classList.add('hidden');

                    radioButtons.forEach(r => {
                        const dot = r.parentElement.querySelector('.w-2.h-2');
                        if (dot) {
                            dot.classList.toggle('hidden', !r.checked);
                        }
                    });

                    if (this.value === 'email') {
                        emailField.classList.remove('hidden');
                        document.getElementById('emailAddress').focus();
                    } else if (this.value === 'sms') {
                        smsField.classList.remove('hidden');
                        document.getElementById('phoneNumber').focus();
                    } else if (this.value === 'push') {
                        pushInfo.classList.remove('hidden');
                    }
                });
            });

            pushInfo.classList.remove('hidden');
        }

        // Reminder scheduling and trial management
        function scheduleReminder(trial) {
            const endDate = new Date(trial.endDate);
            const now = new Date();
            const reminderDays = [7, 3, 1];

            reminderDays.forEach(days => {
                const reminderDate = new Date(endDate);
                reminderDate.setDate(reminderDate.getDate() - days);

                if (reminderDate > now) {
                    const timeout = reminderDate.getTime() - now.getTime();
                    setTimeout(() => {
                        sendReminder(trial, days);
                    }, timeout);
                }
            });
        }

        function scheduleAllReminders() {
            trials.forEach(trial => {
                if (trial.status !== 'expired') {
                    scheduleReminder(trial);
                }
            });
        }

        async function sendReminder(trial, daysLeft) {
            const title = 'Gentle Reminder from FreeTrialGuard';
            const body = `Your ${trial.serviceName} trial ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}. Take care! `;

            NotificationService.showPushNotification(title, body);
            updateTrialStatus(trial.id, daysLeft);
        }

        function updateTrialStatus(trialId, daysLeft) {
            const trial = trials.find(t => t.id === trialId);
            if (trial) {
                if (daysLeft <= 0) {
                    trial.status = 'expired';
                } else if (daysLeft <= 1) {
                    trial.status = 'ending-soon';
                } else if (daysLeft <= 3) {
                    trial.status = 'reminder-sent';
                }
                saveTrials();
                renderTrials();
            }
        }

        // UI Functions
        function showToast(message, type = 'gentle') {
            elements.toastContent.textContent = message;
            elements.toast.className = `fixed top-20 left-4 right-4 z-40 rounded-xl p-4 text-center transition-all duration-300 notification-${type}`;
            elements.toast.classList.remove('hidden');

            setTimeout(() => {
                elements.toast.classList.add('hidden');
            }, 3000);
        }

        function getTrialStatus(trial) {
            const endDate = new Date(trial.endDate);
            const now = new Date();
            const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

            if (daysLeft < 0) return { status: 'expired', text: 'Trial has ended', class: 'text-red-500', icon: 'fas fa-times-circle' };
            if (daysLeft === 0) return { status: 'ending-today', text: 'Ends today', class: 'text-orange-500', icon: 'fas fa-exclamation-circle' };
            if (daysLeft === 1) return { status: 'ending-soon', text: 'Ends tomorrow', class: 'text-yellow-500', icon: 'fas fa-clock' };
            if (daysLeft <= 3) return { status: 'reminder-sent', text: `${daysLeft} days left`, class: 'text-blue-500', icon: 'fas fa-bell' };
            if (daysLeft <= 7) return { status: 'upcoming', text: `${daysLeft} days left`, class: 'text-green-500', icon: 'fas fa-calendar-check' };
            return { status: 'safe', text: 'Safe for now', class: 'text-gray-500', icon: 'fas fa-leaf' };
        }

        function renderTrials() {
            if (trials.length === 0) {
                elements.trialsContainer.classList.add('hidden');
                elements.emptyState.classList.remove('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.trialsContainer.classList.remove('hidden');

            const sortedTrials = [...trials].sort((a, b) => new Date(a.endDate) - new Date(b.endDate));

            elements.trialsContainer.innerHTML = sortedTrials.map(trial => {
                const status = getTrialStatus(trial);
                const endDate = new Date(trial.endDate);

                return `
                    <div class="bg-white rounded-xl p-6 gentle-shadow fade-in hover:shadow-lg transition-all duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-800">${trial.serviceName}</h3>
                                    <div class="flex items-center space-x-1 ${status.class}">
                                        <i class="${status.icon} text-sm"></i>
                                        <span class="text-sm font-medium">${status.text}</span>
                                    </div>
                                </div>

                                <div class="text-gray-600 mb-2">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    Ends ${endDate.toLocaleDateString('en-US', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    })}
                                </div>

                                <div class="text-sm text-gray-500 mb-3">
                                    <i class="fas fa-${trial.reminderMethod === 'push' ? 'bell' : trial.reminderMethod === 'email' ? 'envelope' : 'sms'} mr-2"></i>
                                    ${trial.reminderMethod === 'push' ? 'Browser notifications' : trial.reminderMethod === 'email' ? 'Email reminders' : 'SMS reminders'}
                                    ${trial.contact && trial.reminderMethod !== 'push' ? ` to ${trial.contact}` : ''}
                                </div>
                            </div>

                            <div class="flex items-center space-x-2 ml-4">
                                <button onclick="editTrial('${trial.id}')" class="p-2 text-gray-400 hover:text-blue-500 transition-colors" title="Edit trial">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTrial('${trial.id}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors" title="Delete trial">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addTrial(trialData) {
            const trial = {
                id: Date.now().toString(),
                ...trialData,
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            trials.push(trial);
            saveTrials();
            renderTrials();
            scheduleReminder(trial);

            showToast(`${trial.serviceName} trial added with gentle reminders scheduled`, 'success');
        }

        function deleteTrial(id) {
            if (confirm('Are you sure you want to remove this trial? This action cannot be undone.')) {
                trials = trials.filter(trial => trial.id !== id);
                saveTrials();
                renderTrials();
                showToast('Trial removed peacefully', 'gentle');
            }
        }

        function editTrial(id) {
            const trial = trials.find(t => t.id === id);
            if (trial) {
                document.getElementById('serviceName').value = trial.serviceName;
                document.getElementById('endDate').value = trial.endDate;

                const radioButton = document.querySelector(`input[name="reminderMethod"][value="${trial.reminderMethod}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                    radioButton.dispatchEvent(new Event('change'));
                }

                if (trial.reminderMethod === 'email') {
                    document.getElementById('emailAddress').value = trial.contact || '';
                } else if (trial.reminderMethod === 'sms') {
                    document.getElementById('phoneNumber').value = trial.contact || '';
                }

                elements.trialForm.dataset.editId = id;
                elements.addTrialModal.classList.remove('hidden');
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Modal controls
            [elements.addTrialBtn, elements.emptyState.querySelector('button')].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        elements.addTrialModal.classList.remove('hidden');
                        document.getElementById('serviceName').focus();
                    });
                }
            });

            [elements.closeModal, elements.cancelBtn].forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            // Privacy modal
            elements.privacyInfo.addEventListener('click', () => {
                elements.privacyModal.classList.remove('hidden');
            });

            [elements.closePrivacyModal, elements.closePrivacyBtn].forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.privacyModal.classList.add('hidden');
                });
            });

            // NEW: Calendar button event handler
            elements.addToCalendar.addEventListener('click', () => {
                const serviceName = document.getElementById('serviceName').value.trim();
                const endDate = document.getElementById('endDate').value;

                if (!serviceName || !endDate) {
                    showToast('Please fill in the service name and end date first', 'warning');
                    return;
                }

                downloadICSFile(serviceName, endDate);
            });

                        // Upgrade button removed - informational messaging only

            // Close modals on backdrop click
            [elements.addTrialModal, elements.privacyModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        }

        function closeModal() {
            elements.addTrialModal.classList.add('hidden');
            elements.trialForm.reset();

            // Reset radio buttons to default (push notifications)
            document.querySelector('input[name="reminderMethod"][value="push"]').checked = true;
            document.querySelector('input[name="reminderMethod"][value="push"]').dispatchEvent(new Event('change'));

            // Clear upgrade form
            document.getElementById('upgradeEmail').value = '';
            document.getElementById('upgradePhone').value = '';

            delete elements.trialForm.dataset.editId;
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            elements.installPrompt.classList.remove('hidden');
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                const CACHE_NAME = 'freetrial-guard-v4';
                const urlsToCache = [
                    '/',
                    'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css',
                    'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css',
                    'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap'
                ];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => {
                                return response || fetch(event.request);
                            })
                    );
                });

                self.addEventListener('notificationclick', (event) => {
                    event.notification.close();
                    event.waitUntil(
                        clients.openWindow('/')
                    );
                });
            `))
            .then(() => {
                console.log('Service Worker registered successfully');
            })
            .catch((error) => {
                console.log('Service Worker registration failed:', error);
            });
        }

        // Global functions for trial management
        window.deleteTrial = deleteTrial;
        window.editTrial = editTrial;

        // Initialize App
        async function initializeApp() {
            // Request notification permission
            await NotificationService.requestPermission();

            // Initialize database
            initDB();

            // Setup event handlers
            setupEventListeners();
            setupReminderMethodHandlers();

            console.log('FreeTrialGuard initialized peacefully â¨');
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"97d2551fb83ccf90","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.8.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>