<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeTrialGuard - Your Mindful Trial Companion</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRnJlZVRyaWFsR3VhcmQiLCJzaG9ydF9uYW1lIjoiVHJpYWxHdWFyZCIsImRlc2NyaXB0aW9uIjoiWW91ciBtaW5kZnVsIHRyaWFsIGNvbXBhbmlvbiIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM3NDE1MSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmYWZjIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBLVR6Z2lJR1pwYkc5OUlpTXpOemN4TlRFaVBqeHdZWFJvSUdROUltMDJOQ0EySUV3eE1qSWdOaUJzTUNBeE1UWWdNVElnTUNCc01USXVMV0V4TWkxTWJETTJMaUF5TkNBeU5DQXlOQ0IxSUVGNk1UUWdNamd1T0RBME1qa3VNRGc0TVRZZ01qZ3VNRGd5TkRJZ05UUXVNRFF3TlRJZ05UUXVNREF5TlRjZ09UQXVPVFF6T0RBZ09UQXVPVE0xTnpjZ01USTBMRFV6TVRZMklERXlOQzQxTXpFMk5qWlNNVEl1TFRkaGVHaERaekE0THpocVkyRTVNREU4SWpwOEwzTjJaejQ9IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjEyOHgxMjgifV19">
    <style>
      * {
        font-family: 'Inter', sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 50%, #eef2ff 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      .gentle-shadow {
        box-shadow: 0 4px 20px rgba(56, 178, 172, 0.08);
      }

      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .notification-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
      }

      .notification-warning {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
      }

      .notification-gentle {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        color: #0c4a6e;
      }

      .centered-branding {
        text-align: center;
        padding: 2rem 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 2rem;
      }

      .app-icon {
        width: 3rem;
        height: 3rem;
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        border-radius: 0.75rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .upgrade-section {
        background: linear-gradient(135deg, #fef3e2 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        text-align: center;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
      }

      .trial-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 20px rgba(56, 178, 172, 0.08);
      }

      .toast {
        position: fixed;
        top: 2rem;
        left: 50%;
        transform: translateX(-50%);
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        z-index: 1001;
        display: none;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 1rem;
      }

      .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }

      .privacy-info-button {
        background: none;
        border: none;
        color: #6366f1;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: underline;
        padding: 1rem;
        display: block;
        margin: 2rem auto;
      }

      .empty-state-icon {
        font-size: 4rem;
        color: #3b82f6;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <div id="toastContent"></div>
    </div>

    <!-- PWA Install Prompt -->
    <div id="installPrompt" style="
        display: none;
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        z-index: 1002;
        background: white;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      ">
      <div style="display: flex; align-items: center; justify-content: space-between">
        <div style="display: flex; align-items: center; gap: 0.75rem">
          <i class="fas fa-mobile-alt" style="color: #3b82f6"></i>
          <span>Add FreeTrialGuard to your home screen for peaceful access</span>
        </div>
        <div style="display: flex; gap: 0.5rem">
          <button id="installApp" class="btn-primary" style="font-size: 0.875rem; padding: 0.5rem 1rem">Add</button>
          <button id="dismissInstall" class="btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem">
            ×
          </button>
        </div>
      </div>
    </div>

    <!-- Centered Branding Header -->
    <header class="centered-branding">
      <div class="app-icon">
        <i class="fas fa-shield-alt" style="color: white; font-size: 1.5rem"></i>
      </div>
      <h1 style="margin: 0; font-size: 1.875rem; font-weight: 600; color: #374151">FreeTrialGuard</h1>
      <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 1rem">Your mindful trial companion</p>
    </header>

    <!-- Main Content -->
    <main style="max-width: 1024px; margin: 0 auto; padding: 0 1rem">
      <!-- New Intro Message -->
      <div id="welcomeMessage" style="text-align: center; margin-bottom: 3rem" class="fade-in">
        <div style="margin-bottom: 2rem">
          <i class="fas fa-calendar-check empty-state-icon"></i>
        </div>
        <h2 style="font-size: 1.75rem; font-weight: 400; color: #374151; margin-bottom: 1rem">
          Never forget to cancel a free trial offer again.
        </h2>
        <p style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1rem">
          Track your subscriptions. Get reminders. Stay in control.
        </p>
        <button onclick="openAddTrialModal()" class="btn-primary" style="font-size: 1rem; padding: 1rem 2rem">
          <i class="fas fa-plus" style="margin-right: 0.5rem"></i>Add Your First Trial
        </button>
      </div>

      <!-- Trials Container -->
      <div id="trialsContainer" style="display: none">
        <!-- Trials will be rendered here -->
      </div>

      <!-- Empty State -->
      <div id="emptyState" style="text-align: center; padding: 4rem 0">
        <div style="margin-bottom: 2rem">
          <i class="fas fa-calendar-check empty-state-icon"></i>
        </div>
        <h3 style="font-size: 1.25rem; font-weight: 300; color: #4b5563; margin-bottom: 1rem">
          Your peaceful space awaits
        </h3>
        <p style="color: #6b7280; margin-bottom: 2rem">Add your first trial and let us handle the gentle reminders</p>
        <button onclick="openAddTrialModal()" class="btn-primary">
          <i class="fas fa-plus" style="margin-right: 0.5rem"></i>Add Your First Trial
        </button>
      </div>

      <!-- Privacy Information Button (Footer) -->
      <div style="text-align: center; margin-top: 3rem">
        <button onclick="openPrivacyModal()" class="privacy-info-button">
          <i class="fas fa-user-shield" style="margin-right: 0.5rem"></i>Privacy Information
        </button>
      </div>
    </main>

    <!-- Add Trial Modal -->
    <div id="addTrialModal" class="modal-overlay">
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem">
          <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600">Add New Trial</h3>
          <button onclick="closeAddTrialModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280">
            ×
          </button>
        </div>

        <form id="trialForm" onsubmit="addTrial(event)">
          <div class="form-group">
            <label>Service Name</label>
            <input type="text" id="serviceName" placeholder="Netflix, Spotify, etc." required>
          </div>

          <div class="form-group">
            <label>Trial End Date</label>
            <input type="date" id="endDate" required>
          </div>

          <div class="form-group">
            <label>Reminder Method</label>
            <div style="
                background: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-top: 0.5rem;
              ">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem">
                <i class="fas fa-bell" style="color: #3b82f6"></i>
                <span style="font-weight: 500">Browser Notifications</span>
                <span style="
                    background: #d1fae5;
                    color: #065f46;
                    padding: 0.25rem 0.5rem;
                    border-radius: 1rem;
                    font-size: 0.75rem;
                  ">Recommended</span>
              </div>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280">
                Gentle notifications appear directly in your browser - no setup needed!
              </p>
            </div>
          </div>

          <div class="form-group">
            <button type="button" onclick="generateCalendar()" style="
                width: 100%;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border: none;
                padding: 1rem;
                border-radius: 0.5rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
              ">
              <i class="fas fa-calendar-plus"></i>
              <span>Add to Calendar</span>
            </button>
            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem">
              Download a calendar file with automatic reminders (3 days before)
            </p>

            <!-- Upgrade Message -->
            <div class="upgrade-section">
              <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem">
                <i class="fas fa-star" style="color: #f59e0b"></i>
                <strong>Add an Extra-layer of Protection with sound and message Notifications for $1.99!</strong>
              </div>
              <p style="margin: 0; font-size: 0.875rem">
                Get 7, 3, and 1 day reminders with both visual alerts and sound notifications
              </p>
            </div>
          </div>

          <div class="button-group">
            <button type="button" onclick="closeAddTrialModal()" class="btn-secondary" style="flex: 1">Cancel</button>
            <button type="submit" class="btn-primary" style="flex: 1">Add Trial</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Privacy Modal -->
    <div id="privacyModal" class="modal-overlay">
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem">
          <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600">Your Privacy Matters</h3>
          <button onclick="closePrivacyModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280">
            ×
          </button>
        </div>

        <div style="margin-bottom: 2rem">
          <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem">
            <i class="fas fa-shield-alt" style="color: #10b981; margin-top: 0.25rem"></i>
            <div>
              <h4 style="margin: 0 0 0.5rem 0; font-weight: 500">Local Storage Only</h4>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280">
                All your trial data stays on your device. We never sync to the cloud.
              </p>
            </div>
          </div>

          <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem">
            <i class="fas fa-user-slash" style="color: #3b82f6; margin-top: 0.25rem"></i>
            <div>
              <h4 style="margin: 0 0 0.5rem 0; font-weight: 500">No Tracking</h4>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280">
                We don't use analytics, cookies, or any tracking technologies.
              </p>
            </div>
          </div>

          <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem">
            <i class="fas fa-bell" style="color: #6366f1; margin-top: 0.25rem"></i>
            <div>
              <h4 style="margin: 0 0 0.5rem 0; font-weight: 500">Secure Notifications</h4>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280">
                Browser notifications and calendar reminders work entirely on your device.
              </p>
            </div>
          </div>

          <div style="display: flex; align-items: flex-start; gap: 1rem">
            <i class="fas fa-heart" style="color: #ef4444; margin-top: 0.25rem"></i>
            <div>
              <h4 style="margin: 0 0 0.5rem 0; font-weight: 500">Built with Care</h4>
              <p style="margin: 0; font-size: 0.875rem; color: #6b7280">
                This app respects your emotional bandwidth and digital well-being.
              </p>
            </div>
          </div>
        </div>

        <button onclick="closePrivacyModal()" class="btn-primary" style="width: 100%">I Understand</button>
      </div>
    </div>

    <script>
      // App State
      let trials = [];
      let notificationPermission = 'default';
      let deferredPrompt;
      let db;

      // IndexedDB Setup
      const dbName = 'FreeTrialGuardDB';
      const dbVersion = 1;

      function initDB() {
        const request = indexedDB.open(dbName, dbVersion);

        request.onerror = () => {
          console.error('Database error:', request.error);
          showToast('Database initialization failed', 'warning');
        };

        request.onsuccess = () => {
          db = request.result;
          loadTrials();
        };

        request.onupgradeneeded = (event) => {
          db = event.target.result;
          const objectStore = db.createObjectStore('trials', { keyPath: 'id' });
          objectStore.createIndex('endDate', 'endDate', { unique: false });
        };
      }

      // Calendar Generation Functions
      function generateICSFile(serviceName, endDate, isPaid = false) {
        const eventDate = new Date(endDate);
        const now = new Date();

        function formatICSDate(date) {
          return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        const eventStart = formatICSDate(eventDate);
        const eventEnd = formatICSDate(new Date(eventDate.getTime() + 60 * 60 * 1000));
        const created = formatICSDate(now);
        const uid = `freetrial-${Date.now()}@freetrialguard.app`;

        let alarmBlocks = '';

        if (isPaid) {
          // Paid tier: 7, 3, 1 days with sound and popup
          const alarmDates = [7, 3, 1].map((days) => {
            const alarmDate = new Date(eventDate);
            alarmDate.setDate(alarmDate.getDate() - days);
            return {
              days: days,
              date: formatICSDate(alarmDate),
              message:
                days === 1
                  ? `Your ${serviceName} trial ends tomorrow.`
                  : `Your ${serviceName} trial ends in ${days} days.`,
            };
          });

          alarmBlocks = alarmDates
            .map(
              (alarm) => `BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:${alarm.message}
TRIGGER;VALUE=DATE-TIME:${alarm.date}
END:VALARM
BEGIN:VALARM
ACTION:AUDIO
DESCRIPTION:Trial reminder sound
TRIGGER;VALUE=DATE-TIME:${alarm.date}
ATTACH;VALUE=URI:Basso
END:VALARM`,
            )
            .join('\n');
        } else {
          // Free tier: 3 days only with popup
          const alarmDate = new Date(eventDate);
          alarmDate.setDate(alarmDate.getDate() - 3);

          alarmBlocks = `BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Your ${serviceName} trial ends in 3 days.
TRIGGER;VALUE=DATE-TIME:${formatICSDate(alarmDate)}
END:VALARM`;
        }

        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FreeTrialGuard//Trial Reminder//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
DTSTART:${eventStart}
DTEND:${eventEnd}
DTSTAMP:${created}
UID:${uid}
CREATED:${created}
DESCRIPTION:Your free trial ends today. Take action if needed.
LAST-MODIFIED:${created}
LOCATION:
SEQUENCE:0
STATUS:CONFIRMED
SUMMARY:Trial Ends: ${serviceName} - FreeTrialGuard
TRANSP:OPAQUE
${alarmBlocks}
END:VEVENT
END:VCALENDAR`;

        return icsContent;
      }

      function downloadICSFile(serviceName, endDate, isPaid = false) {
        const icsContent = generateICSFile(serviceName, endDate, isPaid);
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = `${serviceName.replace(/[^a-zA-Z0-9]/g, '_')}_trial_reminder.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        const tierText = isPaid ? 'premium (7, 3, 1 day reminders with sound)' : 'free (3 day reminder)';
        showToast(`Calendar file downloaded for ${serviceName}! (${tierText})`, 'success');
      }

      function generateCalendar() {
        const serviceName = document.getElementById('serviceName').value.trim();
        const endDate = document.getElementById('endDate').value;

        if (!serviceName || !endDate) {
          showToast('Please fill in the service name and end date first', 'warning');
          return;
        }

        // For now, generate free tier calendar
        // In a real implementation, this would check if user has paid for upgrade
        downloadICSFile(serviceName, endDate, false);
      }

      // Notification Service
      class NotificationService {
        static async requestPermission() {
          if ('Notification' in window) {
            notificationPermission = await Notification.requestPermission();
            return notificationPermission === 'granted';
          }
          return false;
        }

        static showPushNotification(title, body) {
          if (notificationPermission === 'granted') {
            new Notification(title, {
              body: body,
              icon: 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/svgs/solid/shield-alt.svg',
              requireInteraction: false,
              silent: true,
            });
          }
        }
      }

      // Data Management
      function saveTrials() {
        if (!db) return;

        const transaction = db.transaction(['trials'], 'readwrite');
        const objectStore = transaction.objectStore('trials');

        objectStore.clear();
        trials.forEach((trial) => {
          objectStore.add(trial);
        });

        transaction.oncomplete = () => {
          console.log('Trials saved successfully');
        };

        transaction.onerror = () => {
          console.error('Error saving trials');
          showToast('Failed to save trials', 'warning');
        };
      }

      function loadTrials() {
        if (!db) return;

        const transaction = db.transaction(['trials'], 'readonly');
        const objectStore = transaction.objectStore('trials');
        const request = objectStore.getAll();

        request.onsuccess = () => {
          trials = request.result || [];
          renderTrials();
          scheduleAllReminders();
        };

        request.onerror = () => {
          console.error('Error loading trials');
          showToast('Failed to load trials', 'warning');
        };
      }

      // Trial Management
      function addTrial(event) {
        event.preventDefault();

        const serviceName = document.getElementById('serviceName').value.trim();
        const endDate = document.getElementById('endDate').value;

        if (!serviceName || !endDate) {
          showToast('Please fill in all required fields', 'warning');
          return;
        }

        const editId = document.getElementById('trialForm').dataset.editId;

        if (editId) {
          // Edit existing trial
          const trialIndex = trials.findIndex((t) => t.id === editId);
          if (trialIndex !== -1) {
            trials[trialIndex] = {
              ...trials[trialIndex],
              serviceName,
              endDate,
              reminderMethod: 'push',
            };
            showToast(`${serviceName} trial updated successfully`, 'success');
          }
          delete document.getElementById('trialForm').dataset.editId;
        } else {
          // Add new trial
          const trial = {
            id: Date.now().toString(),
            serviceName,
            endDate,
            reminderMethod: 'push',
            createdAt: new Date().toISOString(),
            status: 'active',
          };

          trials.push(trial);
          scheduleReminder(trial);
          showToast(`${serviceName} trial added with gentle reminders scheduled`, 'success');
        }

        saveTrials();
        renderTrials();
        closeAddTrialModal();
      }

      function deleteTrial(id) {
        if (confirm('Are you sure you want to remove this trial? This action cannot be undone.')) {
          trials = trials.filter((trial) => trial.id !== id);
          saveTrials();
          renderTrials();
          showToast('Trial removed peacefully', 'gentle');
        }
      }

      function editTrial(id) {
        const trial = trials.find((t) => t.id === id);
        if (trial) {
          document.getElementById('serviceName').value = trial.serviceName;
          document.getElementById('endDate').value = trial.endDate;
          document.getElementById('trialForm').dataset.editId = id;
          openAddTrialModal();
        }
      }

      // Reminder System
      function scheduleReminder(trial) {
        const endDate = new Date(trial.endDate);
        const now = new Date();
        const reminderDays = [7, 3, 1];

        reminderDays.forEach((days) => {
          const reminderDate = new Date(endDate);
          reminderDate.setDate(reminderDate.getDate() - days);

          if (reminderDate > now) {
            const timeout = reminderDate.getTime() - now.getTime();
            setTimeout(() => {
              sendReminder(trial, days);
            }, timeout);
          }
        });
      }

      function scheduleAllReminders() {
        trials.forEach((trial) => {
          if (trial.status !== 'expired') {
            scheduleReminder(trial);
          }
        });
      }

      async function sendReminder(trial, daysLeft) {
        const title = 'Gentle Reminder from FreeTrialGuard';
        const body = `Your ${trial.serviceName} trial ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}. Take care!`;

        NotificationService.showPushNotification(title, body);
        updateTrialStatus(trial.id, daysLeft);
      }

      function updateTrialStatus(trialId, daysLeft) {
        const trial = trials.find((t) => t.id === trialId);
        if (trial) {
          if (daysLeft <= 0) {
            trial.status = 'expired';
          } else if (daysLeft <= 1) {
            trial.status = 'ending-soon';
          } else if (daysLeft <= 3) {
            trial.status = 'reminder-sent';
          }
          saveTrials();
          renderTrials();
        }
      }

      // UI Functions
      function showToast(message, type = 'gentle') {
        const toast = document.getElementById('toast');
        const toastContent = document.getElementById('toastContent');

        toastContent.textContent = message;
        toast.className = `toast notification-${type}`;
        toast.style.display = 'block';

        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }

      function getTrialStatus(trial) {
        const endDate = new Date(trial.endDate);
        const now = new Date();
        const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

        if (daysLeft < 0)
          return { status: 'expired', text: 'Trial has ended', class: 'color: #ef4444', icon: 'fas fa-times-circle' };
        if (daysLeft === 0)
          return {
            status: 'ending-today',
            text: 'Ends today',
            class: 'color: #f97316',
            icon: 'fas fa-exclamation-circle',
          };
        if (daysLeft === 1)
          return { status: 'ending-soon', text: 'Ends tomorrow', class: 'color: #eab308', icon: 'fas fa-clock' };
        if (daysLeft <= 3)
          return {
            status: 'reminder-sent',
            text: `${daysLeft} days left`,
            class: 'color: #3b82f6',
            icon: 'fas fa-bell',
          };
        if (daysLeft <= 7)
          return {
            status: 'upcoming',
            text: `${daysLeft} days left`,
            class: 'color: #10b981',
            icon: 'fas fa-calendar-check',
          };
        return { status: 'safe', text: 'Safe for now', class: 'color: #6b7280', icon: 'fas fa-leaf' };
      }

      function renderTrials() {
        const trialsContainer = document.getElementById('trialsContainer');
        const emptyState = document.getElementById('emptyState');
        const welcomeMessage = document.getElementById('welcomeMessage');

        if (trials.length === 0) {
          trialsContainer.style.display = 'none';
          emptyState.style.display = 'block';
          welcomeMessage.style.display = 'block';
          return;
        }

        welcomeMessage.style.display = 'none';
        emptyState.style.display = 'none';
        trialsContainer.style.display = 'block';

        const sortedTrials = [...trials].sort((a, b) => new Date(a.endDate) - new Date(b.endDate));

        trialsContainer.innerHTML = sortedTrials
          .map((trial) => {
            const status = getTrialStatus(trial);
            const endDate = new Date(trial.endDate);

            return `
                    <div class="trial-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">${trial.serviceName}</h3>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; ${status.class};">
                                        <i class="${status.icon}" style="font-size: 0.875rem;"></i>
                                        <span style="font-size: 0.875rem; font-weight: 500;">${status.text}</span>
                                    </div>
                                </div>

                                <div style="color: #6b7280; margin-bottom: 0.5rem;">
                                    <i class="fas fa-calendar-alt" style="margin-right: 0.5rem;"></i>
                                    Ends ${endDate.toLocaleDateString('en-US', {
                                      weekday: 'long',
                                      year: 'numeric',
                                      month: 'long',
                                      day: 'numeric',
                                    })}
                                </div>

                                <div style="font-size: 0.875rem; color: #9ca3af;">
                                    <i class="fas fa-bell" style="margin-right: 0.5rem;"></i>
                                    Browser notifications enabled
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="editTrial('${trial.id}')" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 0.5rem;" title="Edit trial">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTrial('${trial.id}')" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 0.5rem;" title="Delete trial">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join('');
      }

      // Modal Functions
      function openAddTrialModal() {
        document.getElementById('addTrialModal').style.display = 'flex';
        document.getElementById('serviceName').focus();
      }

      function closeAddTrialModal() {
        document.getElementById('addTrialModal').style.display = 'none';
        document.getElementById('trialForm').reset();
        delete document.getElementById('trialForm').dataset.editId;
      }

      function openPrivacyModal() {
        document.getElementById('privacyModal').style.display = 'flex';
      }

      function closePrivacyModal() {
        document.getElementById('privacyModal').style.display = 'none';
      }

      // PWA Installation
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'block';
      });

      document.getElementById('installApp').addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            showToast('FreeTrialGuard added to home screen!', 'success');
          }
          deferredPrompt = null;
          document.getElementById('installPrompt').style.display = 'none';
        }
      });

      document.getElementById('dismissInstall').addEventListener('click', () => {
        document.getElementById('installPrompt').style.display = 'none';
      });

      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .register(
            'data:text/javascript;base64,' +
              btoa(`
                const CACHE_NAME = 'freetrial-guard-v5';
                const urlsToCache = [
                    '/',
                    'https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css',
                    'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css',
                    'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap'
                ];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => {
                                return response || fetch(event.request);
                            })
                    );
                });

                self.addEventListener('notificationclick', (event) => {
                    event.notification.close();
                    event.waitUntil(
                        clients.openWindow('/')
                    );
                });
            `),
          )
          .then(() => {
            console.log('Service worker registered successfully');
          })
          .catch((error) => {
            console.log('Service worker registration failed:', error);
          });
      }

      // Initialize App
      document.addEventListener('DOMContentLoaded', () => {
        initDB();
        NotificationService.requestPermission();

        // Close modals on backdrop click
        document.getElementById('addTrialModal').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closeAddTrialModal();
          }
        });

        document.getElementById('privacyModal').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closePrivacyModal();
          }
        });
      });
    </script>
  </body>
</html>
